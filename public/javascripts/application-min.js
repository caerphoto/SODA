
$(function(){"use strict";var $html=$("html"),$input=$("#editor textarea").length?$("#editor textarea"):$("#doc-source"),$editorBox=$("#editor"),$docTitle=$("#doc-title"),$previewScroller=$("#preview-scroller"),$preview=$("#preview"),$pages=$(".page"),$htmlView=$("#html-view textarea"),$toolbar=$("#toolbar"),$chkMonospace=$("#chk-monospace"),$chkLinebreaks=$("#chk-linebreaks"),$chkSmartQuotes=$("#chk-smart-quotes"),$chkSmartDashes=$("#chk-smart-dashes"),$chkSmartEllipses=$("#chk-smart-ellipses"),$chkPrivateDoc=$("#chk-private-doc"),$rdoPreviewOff=$("#rdo-preview-off"),$rdoPreviewPrint=$("#rdo-preview-print"),$rdoPreviewHTML=$("#rdo-preview-html"),$rdoActualSize=$("#rdo-actual-size"),$rdoScalePreview=$("#rdo-scale-preview"),$rdoFitWidth=$("#rdo-fit-width"),$chkPageMargins=$("#chk-page-margins"),$txtBaseFont=$("#txt-base-font"),$txtBaseFontSize=$("#txt-base-font-size"),$txtHeadingFont=$("#txt-heading-font"),$lastSaved=$("#last-saved"),$btnSave=$("#btn-save"),$debug=$("#debug"),$saving=$("#doc-saving-message"),$zoomLevel=$("#zoom-level"),$updateSpeed=$("#update-speed"),$syntaxGuide=$("#syntax-guide"),$editorSizer=$("#editor-sizer"),showdown=new Showdown.converter(),prevText="",lastSavedText,lastSavedTitle,savedState={},currentState={},ageTimer,saveTimer,updateTimer,updateSpeed=200,docPath=$("#doc-path").val(),previewVisible=true,sizingEditor=false,sizeOffset,editingDocument=$editorBox.length>0,previewMargin=$previewScroller.outerWidth(true)-$previewScroller.outerWidth(),editorMargin=editingDocument?$editorBox.offset().left:0,editorPadding=$editorBox.innerWidth()-$editorBox.width(),PAGE_WIDTH=210,PAGE_HEIGHT=297,DEFAULT_SAVE_INTERVAL=1000*30,SAVE_INTERVAL=DEFAULT_SAVE_INTERVAL,zoom=1,PPI=96,PPMM=PPI/25.4,pxToPt,ptToPx,pxToMm,ptToMm,mmToPx,updatePreview,resetSaveTimer,saveDocument,resetAgeTimer,updateAgeStatus,updateModifiedStatus,changeState,modified;pxToPt=function(px){return px*zoom*72/PPI;};ptToPx=function(pt){return pt*zoom*PPI/72;};mmToPx=function(mm){return mm*zoom*PPMM;};if(!Date.now){Date.now=function now(){return+new Date();};}
updatePreview=function(){var newText,HTML,i,codeblock=/(<code(?:[^>]*)>[^<]*)<\/code>/g,codeblocks=[],fCodeblocks=[],mlCodeblocks=[],newlines=[],HTMLView=$rdoPreviewHTML.attr("checked"),updateStart,extractCodeblocks,restoreCodeblocks;if(!previewVisible){return;}
updateStart=Date.now();extractCodeblocks=function(){newText=newText.replace(/~/,"~T");fCodeblocks=[];i=-1;newText=newText.replace(/```((?:.|\n)+?)```/g,function(wholeMatch,code){i+=1;fCodeblocks[i]="```"+code+"```";return"~F"+i;});mlCodeblocks=[];i=-1;newText=newText.replace(/((\n+([ ]{4}|\t).+)+)/g,function(wholeMatch,code){i+=1;mlCodeblocks[i]="    "+code;return"~M"+i;});codeblocks=[];i=-1;newText=newText.replace(/`(.+)`/g,function(){i+=1;codeblocks[i]=arguments[1];return"~C"+i;});};restoreCodeblocks=function(){i=-1;newText=newText.replace(/~F\d{1,4}[~]?/g,function(){i+=1;return fCodeblocks[i];});i=-1;newText=newText.replace(/~M\d{1,4}[~]?/g,function(){i+=1;return mlCodeblocks[i];});i=-1;newText=newText.replace(/~C\d{1,4}/g,function(){i+=1;return"`"+codeblocks[i]+"`";});newText=newText.replace(/~T/,"~");};(function(){var doc_title;if($docTitle.children().length){doc_title=$docTitle.children().text();}else{doc_title=$docTitle.val();}
document.title=(doc_title||"<untitled>")+" \u00B7 Soda";}());newText=$input.val();extractCodeblocks();if($chkSmartQuotes.attr("checked")){newText=newText.replace(/"([\w'])/g,"&ldquo;$1").replace(/"/g,"&rdquo;");newText=newText.replace(/\b'\b/g,"&rsquo;").replace(/'\b/g,"&lsquo;").replace(/'/g,"&rsquo;");}
if($chkSmartDashes.attr("checked")){newText=newText.replace(/^-+$/gm,"~D").replace(/---/g,"&mdash;").replace(/--/g,"&ndash;").replace(/~D/g,"----");}
if($chkLinebreaks.attr("checked")){i=-1;newText=newText.replace(/^(#.+)$/gm,"$1\n").replace(/\n{2,}/g,"~N").replace(/\n/g,'<br>\n').replace(/~N/g,"\n\n");}
newText=newText.replace(/\.{3}/g,"&hellip;");restoreCodeblocks();HTML=showdown.makeHtml(newText);if(HTMLView){$htmlView.text(HTML);}else{$pages.html(HTML);}
setTimeout(function(){updateSpeed=Date.now()-updateStart;$updateSpeed.text(updateSpeed);},0);};resetSaveTimer=function(){clearTimeout(saveTimer);SAVE_INTERVAL=DEFAULT_SAVE_INTERVAL;saveTimer=setInterval(function(){saveDocument();},SAVE_INTERVAL);};saveDocument=function(callback){if(!modified()){if(typeof callback==="function"){return callback();}}
ageTimer=clearTimeout(ageTimer);$saving.fadeIn(100);$.ajax({url:docPath,type:"PUT",data:currentState,success:function(status){$saving.fadeOut(100);savedState=currentState;savedState.lastSaved=Date.now();updateModifiedStatus();$input.focus();resetAgeTimer();resetSaveTimer();if(typeof callback==="function"){callback();}},error:function(response){window.alert("Unable to save document.\n\n"+
response.responseText);SAVE_INTERVAL*=1.5;}});};changeState=function(changes){currentState=_({}).extend(currentState,changes);updateModifiedStatus();};modified=function(){var result=false;_(currentState).each(function(value,key){if(currentState[key]!==savedState[key]){result=true;}});return result;};updateModifiedStatus=function(){var mod=modified();$lastSaved.toggle(mod);$btnSave.attr("disabled",!mod);};resetAgeTimer=function(){clearTimeout(ageTimer);ageTimer=setInterval(function(){updateAgeStatus();},5000);};updateAgeStatus=function(){var $docAge=$("#doc-age"),docAge=Math.round((Date.now()-savedState.lastSaved)/1000);if(docAge===0){$docAge.text("just now.");}else if(docAge<=60){$docAge.text(docAge+" seconds ago.");}else{docAge=Math.ceil(docAge/60);$docAge.text(docAge+" minutes ago.");}};$html.click(function(){$(".dropdown-list").hide();});$(".dropdown-list-button").click(function(e){e.stopPropagation();$(".dropdown-list").hide();$(this).next().toggle();});$rdoPreviewOff.click(function(){$previewScroller.hide();previewVisible=false;});$rdoPreviewPrint.click(function(){$previewScroller.show();previewVisible=true;$previewScroller.removeClass("raw");updatePreview();});$rdoPreviewHTML.click(function(){$previewScroller.show();previewVisible=true;$previewScroller.toggleClass("raw",$rdoPreviewHTML.attr("checked"));updatePreview();});$("#app-loading-message").remove();updatePreview();if(!editingDocument){return;}
$chkPageMargins.change(function(){$preview.toggleClass("no-margins",!$chkPageMargins.attr("checked"));});$chkLinebreaks.change(function(){changeState({linebreaks:this.checked});updatePreview();});$chkSmartQuotes.change(function(){changeState({smartQuotes:this.checked});updatePreview();});$chkSmartDashes.change(function(){changeState({smartDashes:this.checked});updatePreview();});$chkSmartEllipses.change(function(){changeState({smartEllipses:this.checked});updatePreview();});$chkPrivateDoc.change(function(){changeState({privateDoc:this.checked});});$chkMonospace.change(function(){$input.toggleClass("monospace",this.checked);});$docTitle.keyup(function(){changeState({title:$docTitle.val()});});$input.keyup(function(){var newText=$input.val();if(newText===prevText){return;}
changeState({content:newText});if(updateTimer){clearTimeout(updateTimer);}
updateTimer=setTimeout(function(){updatePreview();},updateSpeed+200);prevText=newText;}).focus(function(){$(this).parent().parent().addClass("focus");}).blur(function(){$(this).parent().parent().removeClass("focus");});$btnSave.click(function(){saveDocument();});$syntaxGuide.click(function(){$editorBox.toggleClass("show-syntax");$syntaxGuide.scrollTop(0);});$editorSizer.mousedown(function(e){sizingEditor=true;sizeOffset=$editorSizer.width()-
(e.pageX-$editorSizer.offset().left)+1;$editorSizer.addClass("sizing");e.preventDefault();e.stopPropagation();});$html.mousemove(function(e){var editorWidth,previewLeft;if(!sizingEditor){return;}
e.preventDefault();editorWidth=e.pageX-editorMargin-editorPadding+sizeOffset-2;previewLeft=e.pageX+previewMargin+sizeOffset-20;$editorBox.css({right:"auto",width:editorWidth});$previewScroller.css({left:previewLeft});}).mouseup(function(){if(sizingEditor){$(window).resize();}
sizingEditor=false;$editorSizer.removeClass("sizing");});$(window).resize(function(){var fit;zoom=($previewScroller.width()-40)/PAGE_WIDTH/PPMM;if($rdoScalePreview.attr("checked")){$preview.removeClass("fit-width").css({"-webkit-transform":"scale("+zoom+")","-moz-transform":"scale("+zoom+")","-o-transform":"scale("+zoom+")",msTransform:"scale("+zoom+")","transform":"scale("+zoom+")"});}else{fit=!!$rdoFitWidth.attr("checked");$preview.toggleClass("fit-width",fit);$preview.css({"-webkit-transform":"","-moz-transform":"","-o-transform":"",msTransform:"","transform":""});}
$zoomLevel.text(Math.round(zoom*100));});$('input[name="preview-zoom"]').change(function(){$(window).resize();});$("#view-document").click(function(e){var link=this;e.preventDefault();saveDocument(function(){window.location=link.href;});});if(docPath&&editingDocument){if(!$docTitle.val()){$docTitle.focus();}else{$input.focus();}
savedState={lastSaved:Date.now(),content:$input.val(),title:$docTitle.val(),linebreaks:$chkLinebreaks.attr("checked"),smartQuotes:$chkSmartQuotes.attr("checked"),smartDashes:$chkSmartDashes.attr("checked"),privateDoc:$chkPrivateDoc.attr("checked")};changeState(savedState);resetAgeTimer();resetSaveTimer();}
$(window).resize();updatePreview();});